FROM node:fermium-slim
WORKDIR /sitas-sc-test

RUN apt update
COPY src/ ./
RUN npm install

ARG AZURE_SERVICE_BUS_CONNECTION_STRING
ARG AZURE_SERVICE_BUS_DOWNLOAD_REQUEST_QUEUE
ARG AZURE_SERVICE_BUS_DOWNLOAD_REQUEST_SOUNDCLOUD_QUEUE
ARG AZURE_SERVICE_BUS_DOWNLOAD_COMPLETED_QUEUE
ARG MINIO_INTERNAL_ENDPOINT
ARG MINIO_INTERNAL_PORT
ARG MINIO_INTERNAL_USER
ARG MINIO_INTERNAL_PASS
ARG MINIO_INTERNAL_BUCKET
ARG SOUNDCLOUD_CLIENT_ID

ENV AZURE_SERVICE_BUS_CONNECTION_STRING=${AZURE_SERVICE_BUS_CONNECTION_STRING}
ENV MINIO_INTERNAL_PORT=${MINIO_INTERNAL_PORT}
ENV AZURE_SERVICE_BUS_DOWNLOAD_REQUEST_QUEUE=${AZURE_SERVICE_BUS_DOWNLOAD_REQUEST_QUEUE}
ENV AZURE_SERVICE_BUS_DOWNLOAD_REQUEST_SOUNDCLOUD_QUEUE=${AZURE_SERVICE_BUS_DOWNLOAD_REQUEST_SOUNDCLOUD_QUEUE}
ENV AZURE_SERVICE_BUS_DOWNLOAD_COMPLETED_QUEUE=${AZURE_SERVICE_BUS_DOWNLOAD_COMPLETED_QUEUE}
ENV MINIO_INTERNAL_ENDPOINT=${MINIO_INTERNAL_ENDPOINT}
ENV MINIO_INTERNAL_USER=${MINIO_INTERNAL_USER}
ENV MINIO_INTERNAL_PASS=${MINIO_INTERNAL_PASS}
ENV MINIO_INTERNAL_BUCKET=${MINIO_INTERNAL_BUCKET}
ENV SOUNDCLOUD_CLIENT_ID=${SOUNDCLOUD_CLIENT_ID}

ENTRYPOINT [ "npm", "test", "--", "--coverage", "--forceExit"]